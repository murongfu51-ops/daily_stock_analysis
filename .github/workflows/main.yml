import yfinance as yf
import os
import smtplib
from email.mime.text import MIMEText
import google.generativeai as genai
from openai import OpenAI

STOCKS = ["2233.HK", "9926.HK", "2400.HK", "SMMT"]

def ask_ai(p):
    # 1. Gemini 3 (Flash Preview)
    try:
        genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
        return genai.GenerativeModel('gemini-3-flash-preview').generate_content(p).text
    except:
        pass
    # 2. Gemini 2.5 (Flash)
    try:
        return genai.GenerativeModel('gemini-2.5-flash').generate_content(p).text
    except:
        pass
    # 3. åƒé—®ä¿åº•
    try:
        c = OpenAI(api_key=os.getenv("OPENAI_API_KEY"), base_url=os.getenv("OPENAI_BASE_URL"))
        return c.chat.completions.create(model=os.getenv("OPENAI_MODEL"), messages=[{"role":"user","content":p}]).choices[0].message.content
    except:
        return "AI Failed"

def send_email(content):
    msg = MIMEText(content, 'plain', 'utf-8')
    msg['Subject'] = "ğŸ“Š é¦–å¸­æŠ•ç ”æ€»ç›‘å†³ç­–æŠ¥å‘Š"
    msg['From'] = os.getenv("EMAIL_SENDER")
    msg['To'] = os.getenv("EMAIL_RECEIVERS")
    try:
        with smtplib.SMTP_SSL("smtp.qq.com", 465) as server:
            server.login(os.getenv("EMAIL_SENDER"), os.getenv("EMAIL_PASSWORD"))
            server.send_message(msg)
    except:
        pass

if __name__ == "__main__":
    report = ""
    for s in STOCKS:
        try:
            t = yf.Ticker(s)
            ctx = f"æ ‡çš„:{s},ç°ä»·:{t.fast_info['last_price']:.2f},åŠ¨æ€:{[n['title'] for n in t.news[:3]]}"
            prompt = f"ä½ ä½œä¸ºã€é¦–å¸­æŠ•ç ”æ€»ç›‘ã€‘ï¼ŒèŒè´£æ˜¯ç©¿é€åˆ†æé€»è¾‘ã€‚åˆ†æ:{ctx}ã€‚è¦æ±‚:150å­—å†…,ç¦æ—§é—»ã€‚èšç„¦:è¥¿éƒ¨æ°´æ³¥éæ´²äº§èƒ½ã€åº·æ–¹/SMMTè”åŠ¨ã€å¿ƒåŠ¨æ–°æ¸¸è¡¨ç°ã€‚"
            report += f"\nğŸ¯ {s}\n{ask_ai(prompt)}\n" + "-"*30
        except:
            continue
    if report:
        send_email(report)
