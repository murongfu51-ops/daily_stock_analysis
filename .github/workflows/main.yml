import yfinance as yf
import os
import smtplib
from email.mime.text import MIMEText
import google.generativeai as genai
from openai import OpenAI

STOCKS = ["2233.HK", "9926.HK", "2400.HK", "SMMT"]

def ask_ai(p):
    try:
        genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
        return genai.GenerativeModel('gemini-3-flash-preview').generate_content(p).text
    except:
        pass
    try:
        return genai.GenerativeModel('gemini-2.5-flash').generate_content(p).text
    except:
        pass
    try:
        c = OpenAI(api_key=os.getenv("OPENAI_API_KEY"), base_url=os.getenv("OPENAI_BASE_URL"))
        return c.chat.completions.create(model=os.getenv("OPENAI_MODEL"), messages=[{"role":"user","content":p}]).choices[0].message.content
    except:
        return "AI Failed"

def send_email(content):
    msg = MIMEText(content, 'plain', 'utf-8')
    msg['Subject'] = "æ¯æ—¥æ¸¯ç¾è‚¡æŠ•ç ”å†…å‚"
    msg['From'] = os.getenv("EMAIL_SENDER")
    msg['To'] = os.getenv("EMAIL_RECEIVERS")
    try:
        with smtplib.SMTP_SSL("smtp.qq.com", 465) as server:
            server.login(os.getenv("EMAIL_SENDER"), os.getenv("EMAIL_PASSWORD"))
            server.send_message(msg)
    except:
        pass

if __name__ == "__main__":
    report = "ã€é¦–å¸­æŠ•ç ”æ€»ç›‘å†³ç­–æŠ¥å‘Šã€‘\n"
    for s in STOCKS:
        try:
            t = yf.Ticker(s)
            price = t.fast_info['last_price']
            news = [n['title'] for n in t.news[:3]]
            
            prompt = f"""
            ä½ ä½œä¸ºã€é¦–å¸­æŠ•ç ”æ€»ç›‘ã€‘ï¼Œåˆ†ææ ‡çš„:{s}, ç°ä»·:{price:.2f}ã€‚
            å‚è€ƒåŠ¨æ€:{news}
            è¦æ±‚:
            1. çŸ­ä¸­é•¿æœŸå‘å±•ï¼Œç»™å‡ºçŸ­ä¸­é•¿æœŸé¢„æœŸå›æŠ¥ç‡ã€‚
            2. ç©¿é€åˆ†æè¥¿éƒ¨æ°´æ³¥éæ´²äº§èƒ½ã€åº·æ–¹/SMMTè”åŠ¨ã€å¿ƒåŠ¨æ–°æ¸¸åŠTapTapé€»è¾‘ã€‚
            3. ç»™å‡ºæ˜ç¡®å†³ç­–å¯¼å‘ã€‚
            """
            
            report += f"\nğŸ¯ {s}\n{ask_ai(prompt)}\n" + "-"*30
        except:
            continue
    
    if len(report) > 30:
        send_email(report)
